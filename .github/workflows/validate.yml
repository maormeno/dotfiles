name: Validate

on:
  # Run checks for every pushed branch.
  push:
  # Run checks for every pull request.
  pull_request:

jobs:
  validate:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install chezmoi
        run: brew install chezmoi

      - name: Validate shell syntax
        run: |
          # Bootstrap and shell configs should parse.
          bash -n .setup.sh
          zsh -n dot_zshrc
          # Rendered chezmoi templates should produce valid shell.
          chezmoi execute-template < run_onchange_before_10_brew-essentials-packages.sh.tmpl | bash -n
          chezmoi execute-template < run_onchange_before_20_brew-nice-cli-packages.sh.tmpl | bash -n
          chezmoi execute-template < run_onchange_before_30_cursor-extensions.sh.tmpl | bash -n
          chezmoi execute-template < run_once_after_setup-codex.sh.tmpl | bash -n
          chezmoi execute-template < run_once_after_setup-default-apps.sh.tmpl | bash -n
          chezmoi execute-template < run_once_after_setup-system-settings.sh.tmpl | bash -n

      - name: Validate README command references
        run: |
          # Ensure canonical bootstrap command stays documented.
          grep -n "raw.githubusercontent.com/maormeno/dotfiles/main/.setup.sh" README.md
          # Ensure daily update workflow stays documented.
          grep -n "chezmoi update" README.md
          # Ensure deprecated entrypoint is not documented.
          if grep -n "install.sh" README.md; then
            echo "README must not reference install.sh"
            exit 1
          fi
