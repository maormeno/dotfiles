{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash
set -euo pipefail

# Configure visual-focused macOS defaults once.
echo "Applying one-time macOS visual settings..."

# Close System Settings so defaults writes are not overwritten live.
osascript -e 'tell application "System Settings" to quit' || true

# Always show ~/Library in Finder.
chflags nohidden "$HOME/Library"

# Prefer non-natural scrolling for precision on trackpad.
defaults write -g com.apple.swipescrolldirection -bool false

# Enable right-click corner behavior on trackpad.
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadCornerSecondaryClick -int 2
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadRightClick -bool true
defaults write com.apple.AppleMultitouchTrackpad TrackpadCornerSecondaryClick -int 2
defaults write com.apple.AppleMultitouchTrackpad TrackpadRightClick -bool true

# Make dock auto-hide for more screen space.
defaults write com.apple.dock autohide -bool true

# Set Finder to icon view by default.
defaults write com.apple.finder FXPreferredViewStyle -string "icnv"

# Always show the current folder path at the bottom of Finder windows.
defaults write com.apple.finder ShowPathbar -bool true

# Keep Finder sidebar visible for fast navigation.
defaults write com.apple.finder ShowSidebar -bool true

# Keep scrollbars visible in all apps.
defaults write -g AppleShowScrollBars -string "Always"

# Set keyboard input source order: primary ABC, secondary Spanish, third Japanese Romaji.
# Use InputSourceID values to avoid layout-id differences across macOS versions/hardware.
defaults write com.apple.HIToolbox AppleEnabledInputSources -array \
  '{ "InputSourceKind" = "Keyboard Layout"; "InputSourceID" = "com.apple.keylayout.ABC"; }' \
  '{ "InputSourceKind" = "Keyboard Layout"; "InputSourceID" = "com.apple.keylayout.Spanish-ISO"; }' \
  '{ "InputSourceKind" = "Keyboard Input Method"; "Bundle ID" = "com.apple.inputmethod.Kotoeri.RomajiTyping"; }'

# Keep input-source history aligned with the intended order.
defaults write com.apple.HIToolbox AppleInputSourceHistory -array \
  '{ "InputSourceKind" = "Keyboard Layout"; "InputSourceID" = "com.apple.keylayout.ABC"; }' \
  '{ "InputSourceKind" = "Keyboard Layout"; "InputSourceID" = "com.apple.keylayout.Spanish-ISO"; }' \
  '{ "InputSourceKind" = "Keyboard Input Method"; "Bundle ID" = "com.apple.inputmethod.Kotoeri.RomajiTyping"; }'

# Select ABC as the active/default keyboard input source.
defaults write com.apple.HIToolbox AppleSelectedInputSources -array \
  '{ "InputSourceKind" = "Keyboard Layout"; "InputSourceID" = "com.apple.keylayout.ABC"; }'
defaults write com.apple.HIToolbox AppleCurrentKeyboardLayoutInputSourceID -string "com.apple.keylayout.ABC"

# Restart affected services to apply settings quickly.
killall Dock >/dev/null 2>&1 || true
killall Finder >/dev/null 2>&1 || true
killall cfprefsd >/dev/null 2>&1 || true

echo "macOS visual settings applied."
{{- end -}}
