{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash
set -euo pipefail

# Configure visual-focused macOS defaults once.
echo "Applying one-time macOS visual settings..."

# Close System Settings so defaults writes are not overwritten live.
osascript -e 'tell application "System Settings" to quit' || true

# Always show ~/Library in Finder.
chflags nohidden "$HOME/Library"

# Make dock auto-hide for more screen space.
defaults write com.apple.dock autohide -bool true

# Set Finder to icon view by default.
defaults write com.apple.finder FXPreferredViewStyle -string "icnv"

# Always show the current folder path at the bottom of Finder windows.
defaults write com.apple.finder ShowPathbar -bool true

# Keep Finder sidebar visible for fast navigation.
defaults write com.apple.finder ShowSidebar -bool true

# Keep scrollbars visible in all apps.
defaults write -g AppleShowScrollBars -string "Always"

# Keep Dock minimal: Finder (fixed by macOS) + Ghostty + Arc only.
defaults write com.apple.dock show-recents -bool false
defaults write com.apple.dock persistent-others -array

if command -v dockutil >/dev/null 2>&1; then
  # Finder and Trash are system-fixed; remove everything else.
  dockutil --no-restart --remove all

  if [[ -d "/Applications/Ghostty.app" ]]; then
    dockutil --no-restart --add "/Applications/Ghostty.app"
  elif [[ -d "${HOME}/Applications/Ghostty.app" ]]; then
    dockutil --no-restart --add "${HOME}/Applications/Ghostty.app"
  else
    echo "Ghostty.app not found; not added to Dock."
  fi

  if [[ -d "/Applications/Arc.app" ]]; then
    dockutil --no-restart --add "/Applications/Arc.app"
  elif [[ -d "${HOME}/Applications/Arc.app" ]]; then
    dockutil --no-restart --add "${HOME}/Applications/Arc.app"
  else
    echo "Arc.app not found; not added to Dock."
  fi
else
  echo "dockutil is not installed; skipping Dock app layout."
fi

# Restart affected services to apply settings quickly.
killall Dock >/dev/null 2>&1 || true
killall Finder >/dev/null 2>&1 || true
killall cfprefsd >/dev/null 2>&1 || true

echo "macOS visual settings applied."
{{- end -}}
