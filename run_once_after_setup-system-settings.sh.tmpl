{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash
set -euo pipefail

# Configure visual-focused macOS defaults once.
echo "Applying one-time macOS visual settings..."

# Close System Settings so defaults writes are not overwritten live.
osascript -e 'tell application "System Settings" to quit' || true

# Always show ~/Library in Finder.
chflags nohidden "$HOME/Library"

# Prefer non-natural scrolling for precision on trackpad.
defaults write -g com.apple.swipescrolldirection -bool false

# Enable right-click corner behavior on trackpad.
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadCornerSecondaryClick -int 2
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadRightClick -bool true
defaults write com.apple.AppleMultitouchTrackpad TrackpadCornerSecondaryClick -int 2
defaults write com.apple.AppleMultitouchTrackpad TrackpadRightClick -bool true

# Make dock auto-hide for more screen space.
defaults write com.apple.dock autohide -bool true

# Set Finder to icon view by default.
defaults write com.apple.finder FXPreferredViewStyle -string "icnv"

# Always show the current folder path at the bottom of Finder windows.
defaults write com.apple.finder ShowPathbar -bool true

# Keep Finder sidebar visible for fast navigation.
defaults write com.apple.finder ShowSidebar -bool true

# Keep scrollbars visible in all apps.
defaults write -g AppleShowScrollBars -string "Always"

# Ensure ABC is available without replacing the full enabled source list.
enabled_input_sources="$(defaults read com.apple.HIToolbox AppleEnabledInputSources 2>/dev/null || true)"
if ! printf '%s' "${enabled_input_sources}" | grep -Fq 'KeyboardLayout Name" = ABC;' && \
   ! printf '%s' "${enabled_input_sources}" | grep -Fq 'com.apple.keylayout.ABC'; then
  defaults write com.apple.HIToolbox AppleEnabledInputSources -array-add \
    '{ "InputSourceKind" = "Keyboard Layout"; "InputSourceID" = "com.apple.keylayout.ABC"; }'
fi
unset enabled_input_sources

# Keep history aligned so ABC can be selected consistently.
input_source_history="$(defaults read com.apple.HIToolbox AppleInputSourceHistory 2>/dev/null || true)"
if ! printf '%s' "${input_source_history}" | grep -Fq 'KeyboardLayout Name" = ABC;' && \
   ! printf '%s' "${input_source_history}" | grep -Fq 'com.apple.keylayout.ABC'; then
  defaults write com.apple.HIToolbox AppleInputSourceHistory -array-add \
    '{ "InputSourceKind" = "Keyboard Layout"; "InputSourceID" = "com.apple.keylayout.ABC"; }'
fi
unset input_source_history

# Select ABC as the active/default keyboard input source.
defaults write com.apple.HIToolbox AppleSelectedInputSources -array \
  '{ "InputSourceKind" = "Keyboard Layout"; "InputSourceID" = "com.apple.keylayout.ABC"; }'
defaults write com.apple.HIToolbox AppleCurrentKeyboardLayoutInputSourceID -string "com.apple.keylayout.ABC"

# Restart affected services to apply settings quickly.
killall Dock >/dev/null 2>&1 || true
killall Finder >/dev/null 2>&1 || true
killall cfprefsd >/dev/null 2>&1 || true

echo "macOS visual settings applied."
{{- end -}}
