#!/usr/bin/env node

/**
 * Get themes from the Squirrelsong repo
 *
 * This scripts syncs color themes for:
 * [x] Bat
 * [x] WezTerm
 * [x] Bear
 *
 * Author: Artem Sapegin, sapegin.me
 * License: MIT
 * https://github.com/sapegin/dotfiles
 */

import path from 'path';
import fs from 'fs-extra';
import { execSync } from 'child_process';
import ky from 'ky';
import terminalLink from 'terminal-link';
import { temporaryFileTask } from 'tempy';

const HOME = path.dirname(path.dirname(import.meta.dirname));

const REPO_ROOT =
	'https://raw.githubusercontent.com/sapegin/squirrelsong/master';
const DEST_DIR = `${HOME}/dotfiles/tilde`;

function download(filepath) {
	return ky.get(`${REPO_ROOT}/${encodeURI(filepath)}`).text();
}

function write(file, text) {
	const fullPath = path.join(DEST_DIR, file);
	fs.ensureDir(path.dirname(fullPath));
	return fs.writeFileSync(fullPath, text);
}

async function install(from, toDir) {
	const theme = await download(from);
	const filename = path.basename(from);
	write(path.join(toDir, filename), theme);
}

/**
 * Bat: https://github.com/sharkdp/bat?tab=readme-ov-file#adding-new-themes
 */

console.log('ðŸŒˆ Installing Bat theme...');

await install(
	'/dark/Sublime Text/Squirrelsong Dark/Squirrelsong Dark.tmTheme',
	'.config/bat/themes'
);
execSync(`bat cache --build`);

/**
 * WezTerm
 */

console.log('ðŸŒˆ Installing WezTerm theme...');

await install('dark/WezTerm/squirrelsong-dark.toml', '.config/wezterm/colors');

/**
 * Bear
 */

console.log('ðŸŒˆ Installing Bear theme...');

const bearTheme = await download('light/Bear/Squirrelsong Light.theme');
const bearThemesDir = `/Applications/Bear.app/Contents/Frameworks/BearCore.framework/Resources`;
await temporaryFileTask((tempFile) => {
	fs.writeFileSync(tempFile, bearTheme);
	execSync(
		`sudo -- sh -c 'command rm "${bearThemesDir}/Ayu.theme" > /dev/null 2>&1; command cp "${tempFile}" "${bearThemesDir}/Ayu.theme"'`
	);
});
console.log('ðŸ’¡ Now choose Ayu theme in Bear settings');

// --- 8< -- 8< ---

console.log();
console.log('ðŸ¦œ Install all the remaining themes at:');
console.log(
	terminalLink(
		'https://sapegin.me/squirrelsong/',
		'https://sapegin.me/squirrelsong/#download'
	)
);
